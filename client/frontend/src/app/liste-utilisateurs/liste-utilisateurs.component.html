<div class="toolbar">
  <div class="search-container">
    <input
      type="text"
      class="search-input"
      placeholder="Rechercher un utilisateur..."
      [(ngModel)]="searchQuery"
      (input)="filterUsers()"
    />
  </div>

  <div class="action-links">
    <a routerLink="/register/form-avocat" class="link-btn avocat">+ Avocat</a>
    <a routerLink="/register/form-demandeur" class="link-btn juridique">+ Personnel Juridique</a>
    <a routerLink="/register/form-expert" class="link-btn expert">+ Expert</a>
  </div>
</div>

<table class="table" *ngIf="filteredUtilisateurs.length > 0; else noUsers">
  <thead>
    <tr>
      <th>Image</th>
      <th>Nom</th>
      <th>Prénom</th>
      <th>Type</th>
      <th>Rôle</th>
      <th>Informations supplémentaires</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody>
    <tr *ngFor="let utilisateur of filteredUtilisateurs">
      <td>
        <img *ngIf="utilisateur.imageprofile" [src]="utilisateur.imageprofile" alt="Image de profil" class="profile-img" />
        <img *ngIf="!utilisateur.imageprofile" src="path/to/default-image.jpg" alt="Image par défaut" class="profile-img" />
      </td>
      <td>{{ utilisateur.nom }}</td>
      <td>{{ utilisateur.prenom }}</td>
      <td>{{ utilisateur.additionalInfo?.type || 'Admin' }}</td>
      <td>{{ utilisateur.role || 'Non défini' }}</td>
      <td></td>
      <td class="actions">
        <button class="btn btn-danger" title="Supprimer" (click)="supprimerUtilisateur(utilisateur._id)">
          <i class="fa fa-trash"></i>
        </button>
        <button class="btn btn-primary" title="Modifier" (click)="openEditModal(utilisateur)">
          <i class="fa fa-pencil-alt"></i>
        </button>
        <button class="btn btn-primary" (click)="openRoleModal(utilisateur._id)">
          <i class="fa fa-user-tag"></i>
        </button>
        <button
          class="btn"
          [ngClass]="utilisateur.isActive ? 'btn-success' : 'btn-danger'"
          (click)="toggleActivation(utilisateur._id)">
          <i class="fa" [ngClass]="utilisateur.isActive ? 'fa-toggle-on' : 'fa-toggle-off'"></i>
        </button>
        <button class="btn btn-success" title="Envoyer Email" (click)="openEmailModal(utilisateur._id)">
          <i class="fa fa-envelope"></i>
        </button>
      </td>
    </tr>
  </tbody>
</table>

<ng-template #noUsers>
  <div class="no-users">
    <p>Aucun utilisateur trouvé.</p>
  </div>
</ng-template>

<app-send-email
  *ngIf="isEmailModalOpen"
  [userId]="selectedUserId"
  (closeModal)="closeEmailModal()">
</app-send-email>

<!-- MODAL RÔLE -->
<div *ngIf="isRoleModalOpen" class="role-modal">
  <div class="modal-content">
    <h2>Assigner un rôle à l'utilisateur</h2>
    <select [(ngModel)]="selectedRole" class="role-select form-control">
      <option value="" disabled selected>Choisir un rôle</option>
      <option *ngFor="let role of roles" [value]="role._id">{{ role.nom }}</option>
    </select>
    <div class="modal-actions">
      <button
        class="btn btn-primary"
        (click)="assignRoleToUser(selectedUserId!, selectedRole)"
        [disabled]="!selectedUserId || !selectedRole">
        <i class="fa fa-user-tag"></i> Assigner
      </button>
      <button class="btn btn-secondary" (click)="closeRoleModal()">Annuler</button>
    </div>
  </div>
</div>

<!-- MODAL DE MODIFICATION -->
<div *ngIf="isEditModalOpen && selectedUserToEdit" class="edit-modal">
  <div class="modal-content">
    <h2>Modifier l'utilisateur</h2>
    <form (ngSubmit)="submitEdit()" #editForm="ngForm">
      <label>Nom</label>
      <input type="text" [(ngModel)]="selectedUserToEdit.nom" name="editNom" required class="form-control" />

      <label>Prénom</label>
      <input type="text" [(ngModel)]="selectedUserToEdit.prenom" name="editPrenom" required class="form-control" />

      <label>Email</label>
      <input type="email" [(ngModel)]="selectedUserToEdit.email" name="editEmail" required class="form-control" />

      <!-- Ajoute d'autres champs si nécessaire -->

      <div class="modal-actions">
        <button type="submit" class="btn btn-success" [disabled]="editForm.invalid">Enregistrer</button>
        <button type="button" class="btn btn-secondary" (click)="closeEditModal()">Annuler</button>
      </div>
    </form>
  </div>
</div>