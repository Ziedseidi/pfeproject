<div class="affaires-container">
  <h2>Liste des Affaires</h2>

  <!-- Chargement et erreurs -->
  <div *ngIf="loading" class="loading-state">Chargement en cours...</div>
  <div *ngIf="errorMsg" class="error-state">{{ errorMsg }}</div>

  <!-- Liste des affaires -->
  <div *ngIf="!loading && !errorMsg" class="affaires-list">
    <div *ngFor="let a of affaires" class="affaire-card">
      <div class="affaire-header">
        <h3>Affaire n°{{ a.numeroAffaire }}</h3>
        <span class="degre-badge" [ngClass]="'degre-' + a.degreJuridique.toLowerCase()">
          {{ a.degreJuridique }}
        </span>
      </div>

      <div class="affaire-body">
        <div class="affaire-row">
          <div class="affaire-info">
            <label>Objet</label>
            <p>{{ a.objet || 'Non spécifié' }}</p>
          </div>
          <div class="affaire-info">
            <label>Client</label>
            <p>{{ a.typeClient }}</p>
          </div>
        </div>

        <div class="affaire-row">
          <div class="affaire-info">
            <label>Convocation</label>
            <p>{{ a.dateConvocation | date:'shortDate' }}</p>
          </div>
          <div class="affaire-info">
            <label>Clôture</label>
            <p>{{ a.dateCloture ? (a.dateCloture | date:'shortDate') : 'En cours' }}</p>
          </div>
        </div>

        <div class="affaire-row">
          <div class="affaire-info">
            <label>Réception</label>
            <p>{{ a.clotureApresReception ? 'Oui' : 'Non' }}</p>
          </div>
          <div class="affaire-info">
            <label>Réclamation</label>
            <p>{{ a.reclamation?.type || '—' }}</p>
          </div>
        </div>

        <div class="affaire-row">
          <div class="affaire-info">
            <label>Vol</label>
            <p>{{ a.numeroVol || '—' }}</p>
          </div>
          <div class="affaire-info">
            <label>Numéro saisie</label>
            <p>
              <span *ngFor="let s of a.saisies; let last = last">
                {{ s.numeroSaisie }}<span *ngIf="!last">, </span>
              </span>
              <span *ngIf="!a.saisies || a.saisies.length === 0">—</span>
            </p>
          </div>
        </div>

        <div class="affaire-row">
          <div class="affaire-info">
            <label>Avocat</label>
            <p>
              {{ a.avocat?.nom || '—' }}
              {{ a.avocat?.prenom || '' }}
            </p>
          </div>
          <div class="affaire-info">
            <label>Tribunal</label>
            <p>{{ a.tribunal?.nom || '—' }}</p>
          </div>
        </div>

        <div class="consignation-section">
          <h4>Consignation</h4>
          <div class="consignation-grid">
            <div class="consignation-item">
              <label>Montant</label>
              <p class="highlight">{{ a.consignment?.montant || '—' }} TND</p>
            </div>
            <div class="consignation-item">
              <label>Date Consignation</label>
              <p class="highlight">
                {{ a.consignment?.dateConsignation ? (a.consignment.dateConsignation | date:'shortDate') : 'En cours' }}
              </p>
            </div>
            <div class="consignation-item">
              <label>Date Récupération</label>
              <p class="highlight">
                {{ a.consignment?.dateRecuperation ? (a.consignment.dateRecuperation | date:'shortDate') : 'En cours' }}
              </p>
            </div>
          </div>
        </div>

        <div class="affaire-info remarks">
          <label>Remarques</label>
          <p>{{ a.remarques || 'Aucune remarque' }}</p>
        </div>
      </div>

      <div class="affaire-actions">
        <button class="action-btn edit" (click)="onEdit(a._id)">
          <i class="fas fa-pen"></i> Modifier
        </button>
        <button class="action-btn delete" (click)="onDelete(a._id)">
          <i class="fas fa-trash-alt"></i> Supprimer
        </button>
        <button class="action-btn assign" (click)="onAssign(a._id)">
          <i class="fas fa-user-check"></i> Assigner
        </button>
      </div>
    </div>
  </div>

  <!-- Modal pour l'assignation d'avocat -->
  <div class="modal-overlay" *ngIf="showModal"></div>

  <div *ngIf="showModal" class="avocat-modal">
    <div class="modal-content">
      <h3>Avocats Éligibles</h3>
      
      <div *ngIf="modalError" class="modal-error">
        {{ modalError }}
      </div>
      
      <div *ngIf="modalLoading" class="modal-loading">
        <p>Chargement des avocats...</p>
      </div>
  
      <div *ngIf="!modalLoading" class="avocat-list">
        <div *ngFor="let avocat of avocatsEligibles" class="avocat-item">
          <div class="avocat-info">
            <span class="avocat-name">{{ avocat.utilisateur.nom }} {{ avocat.utilisateur.prenom }}</span>
            <span class="avocat-degre">{{ avocat.degreJuridiction }}</span>
          </div>
          <button class="assign-btn" (click)="assignerAvocat(avocat.utilisateur._id)">
            <i class="fas fa-user-plus"></i> Assigner
          </button>
        </div>
      </div>
    
      <button class="modal-close-btn" (click)="fermerModal()">
        <i class="fas fa-times"></i> Fermer
      </button>
    </div>
  </div>
</div>